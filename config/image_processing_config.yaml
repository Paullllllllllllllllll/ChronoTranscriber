# =============================================================================
# Image Processing Configuration
# =============================================================================
# Controls image preprocessing for different LLM providers, Tesseract OCR,
# and post-processing of transcription output.
#
# Used by:
#   - modules/processing/image_utils.py (image preprocessing pipelines)
#   - modules/processing/pdf_utils.py (PDF page image extraction)
#   - modules/processing/tesseract_utils.py (Tesseract OCR settings)
#   - modules/llm/batch/batching.py (llm_detail for batch requests)
#   - modules/core/workflow.py (target_dpi, postprocessing)
#   - modules/operations/batch/check.py (postprocessing on batch results)
# =============================================================================


# =============================================================================
# 1. OpenAI API Image Processing
# =============================================================================
# Settings for preprocessing images before sending to OpenAI's vision models.
# Applies to synchronous transcription and Batch API.
api_image_processing:
  target_dpi: 300  # DPI for rendering/extracting images before API processing.
  grayscale_conversion: true  # Convert color images to grayscale to reduce noise.
  handle_transparency: true  # Flatten images with alpha onto white background.
  # Controls the fidelity of images sent to the OpenAI Responses API.
  # Values:
  # - high: uses tiling approach (170 tokens per 512×512 tile), better for fine details
  # - low: 512×512 resize, 85 tokens per image, faster/cheaper
  # - auto: omit the parameter and let the model decide
  # Token cost: low=85 tokens; high=85 + (170 × number of 512px tiles)
  llm_detail: high

  # JPEG compression quality (1-100) when saving processed images for API use.
  jpeg_quality: 100

  # Resizing behavior prior to sending to the API.
  # Values:
  # - auto: choose a resizing strategy based on llm_detail
  # - none: do not resize (only transparency/grayscale steps applied)
  # Note: any other value currently behaves like 'auto' (resizing enabled).
  resize_profile: high

  # Parameters for resizing profiles
  # For low detail, cap the longest side to this many pixels (preserve aspect ratio)
  low_max_side_px: 512
  # For high detail, fit into this box (width, height) with padding as needed
  high_target_box: [768, 1536]

# =============================================================================
# 2. Google Gemini API Image Processing
# =============================================================================
# Settings for preprocessing images before sending to Google's Gemini models.
# Google uses media_resolution instead of OpenAI's detail parameter.
google_image_processing:
  target_dpi: 300  # DPI for rendering/extracting images before API processing.
  grayscale_conversion: true  # Convert color images to grayscale to reduce noise.
  handle_transparency: true  # Flatten images with alpha onto white background.
  
  # Controls the resolution of images sent to Google Gemini API.
  # Google uses media_resolution enum instead of OpenAI's detail parameter.
  # Values (Gemini 3 token counts per image):
  # - ultra_high: 2240 tokens - Highest quality, for computer use / fine details (per-part only)
  # - high: 1120 tokens - Recommended for OCR/dense documents, optimal for most use cases
  # - medium: 560 tokens - Balanced quality/cost
  # - low: 280 tokens - Minimal tokens, fast/cheap
  # - auto: MEDIA_RESOLUTION_UNSPECIFIED - Default (1120 for images, 560 for PDFs)
  # Note: Token counts differ for Gemini 2.5 and earlier models (258 tokens via Pan and Scan).
  media_resolution: high

  # JPEG compression quality (1-100) when saving processed images for API use.
  jpeg_quality: 100

  # Resizing behavior prior to sending to the API.
  # Google's token calculation uses 768x768 tiles, so we optimize for that.
  # Values:
  # - auto: choose a resizing strategy based on media_resolution
  # - none: do not resize (only transparency/grayscale steps applied)
  # Note: any other value currently behaves like 'auto' (resizing enabled).
  resize_profile: high

  # Parameters for resizing profiles
  # For low resolution, cap the longest side to this many pixels (preserve aspect ratio)
  low_max_side_px: 512
  # For high resolution, fit into this box (width, height) with padding as needed
  # Google uses 768x768 tiles, so we use a box that's a multiple of 768
  high_target_box: [768, 1536]

# =============================================================================
# 3. Anthropic Claude API Image Processing
# =============================================================================
# Settings for preprocessing images before sending to Anthropic's Claude models.
#
# Anthropic guidelines:
#   - Recommended: long edge ≤ 1568px, ≤ 1.15 megapixels for optimal latency
#   - Minimum: 200px on any edge
#   - Maximum: 8000×8000px (or 2000×2000 if >20 images in one request)
#   - Token calculation: tokens = (width × height) / 750
#   - Example: 1568×1568 image ≈ 3,276 tokens; 1024×1024 ≈ 1,398 tokens
#   - Note: Anthropic auto-resizes images >1568px (adds latency without benefit)
anthropic_image_processing:
  target_dpi: 300  # DPI for rendering/extracting images before API processing.
  grayscale_conversion: true  # Convert color images to grayscale to reduce noise.
  handle_transparency: true  # Flatten images with alpha onto white background.
  
  # JPEG compression quality (1-100) when saving processed images for API use.
  jpeg_quality: 100

  # Resizing behavior prior to sending to the API.
  # Anthropic auto-resizes internally, but pre-resizing to ≤1568px reduces latency.
  # Values:
  # - auto: apply provider-specific resizing (default, uses high_max_side_px)
  # - high: cap the longest side to high_max_side_px (1568px, Anthropic's optimal)
  # - low: cap the longest side to low_max_side_px (512px, minimal tokens)
  # - none: do not resize (only transparency/grayscale steps applied)
  # Best practice: pre-resize to ≤1568px to avoid server-side resizing latency.
  resize_profile: auto

  # Parameters for resizing profiles
  # For low detail, cap the longest side to this many pixels (preserve aspect ratio)
  low_max_side_px: 512
  # For high detail, cap the longest side to Anthropic's optimal 1568 pixels
  # No padding needed - Anthropic handles aspect ratios natively
  high_max_side_px: 1568

# =============================================================================
# 4. Tesseract OCR Image Processing
# =============================================================================
# Settings for preprocessing images before local Tesseract OCR.
# Includes engine configuration, binary path, and preprocessing pipeline.
tesseract_image_processing:
  # Resolution for page rendering and image saving; DPI metadata is embedded if enabled.
  target_dpi: 300

  # OCR engine settings and optional binary location
  ocr:
    tesseract_config: "--oem 3 --psm 6"  # '--oem 3' default engine; '--psm 6' uniform block of text
    tesseract_cmd: 'C:\\Program Files (x86)\\Tesseract-OCR\\tesseract.exe'  # Optional absolute path on Windows

  # Preprocessing pipeline exclusively for Tesseract
  preprocessing:
    flatten_alpha: true            # Remove/flatten transparency to white background
    grayscale: true                # Convert to grayscale before thresholding
    invert_to_dark_on_light: auto  # auto|always|never -> ensure dark text on light bg
    deskew: true                   # Detect and correct page skew
    denoise: median                # none|median|bilateral
    binarization: sauvola          # sauvola|adaptive|otsu
    sauvola_window: 25             # odd window size for Sauvola
    sauvola_k: 0.2                 # Sauvola k parameter
    morphology: none               # none|open|close|erode|dilate
    morph_kernel: 3                # odd kernel size for morphology
    border_px: 10                  # add a white border to avoid cropping text near edges
    output_format: png             # png|tiff (lossless)
    preserve_resolution: true      # do not resize/box-fit for Tesseract
    embed_dpi_metadata: true       # embed DPI metadata in output files

# =============================================================================
# 5. Post-Processing Settings
# =============================================================================
# Applied to final transcription text before writing to file. Cleans up OCR
# artifacts, normalizes whitespace, and optionally wraps long lines while
# preserving Markdown formatting and semantic content.
#
# Used by:
#   - modules/processing/postprocess.py (postprocess_transcription function)
#   - modules/core/workflow.py (after transcription completes)
#   - modules/operations/batch/check.py (after batch results retrieved)
# =============================================================================

postprocessing:
  # Master toggle. When false, transcription output is written as-is.
  enabled: true
  
  # Merge hyphenated line breaks (e.g., "politi-\nche" -> "politiche").
  # Uses conservative heuristics to preserve compound words like "Jean-Baptiste".
  # Only merges when both sides are lowercase word fragments.
  merge_hyphenation: false
  
  # Collapse 3+ internal spaces between words down to exactly 2 spaces.
  # Cleans OCR artifacts while preserving spacing for tables/formatted content.
  collapse_internal_spaces: true
  
  # Maximum consecutive blank lines to keep. Extras are removed.
  # Set to 0 to remove all blank lines.
  max_blank_lines: 2
  
  # Tab expansion width. Tabs become spaces for consistent formatting.
  tab_size: 4
  
  # Line wrapping for long lines. Breaks at word boundaries, preserves indentation.
  # Headings, page markers, table rows, and error placeholders are never wrapped.
  wrap_lines: true
  
  # Auto-compute wrap width from average line length of text blocks.
  # Takes precedence over wrap_width when both wrap_lines and auto_wrap are true.
  auto_wrap: false
  
  # Explicit wrap width (characters). Only used when wrap_lines=true and auto_wrap=false.
  # Common values: 80 (terminal), 100 (wide editor), 120 (modern screens). null=80.
  wrap_width: 120
